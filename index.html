<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DW Location Tracker - v2.1 with Sheets Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #f44336;
            --info-color: #2196F3;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        body.dark-mode {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            color: white;
            border-bottom: 1px solid var(--glass-border);
            position: relative;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .config-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .config-panel h3 {
            color: white;
            margin-bottom: 1rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--success-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .btn {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, var(--info-color), #1976D2);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #d32f2f);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #f57c00);
        }
        
        .map-container {
            flex: 1;
            margin: 1rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-height: 500px;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        
        .map-placeholder {
            color: white;
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.7;
        }
        
        .alert {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            color: var(--warning-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .alert.success {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
            color: var(--success-color);
        }
        
        .alert.error {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
            color: var(--danger-color);
        }
        
        .alert.info {
            background: rgba(33, 150, 243, 0.1);
            border-color: rgba(33, 150, 243, 0.3);
            color: var(--info-color);
        }
        
        .setup-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .setup-form.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .setup-form h3 {
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .setup-form input,
        .setup-form select {
            background: white;
            border: 2px solid #ddd;
            color: #333;
        }
        
        .setup-form input:focus,
        .setup-form select:focus {
            border-color: var(--success-color);
        }
        
        .quick-start {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success-color);
        }
        
        .quick-start h4 {
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .quick-start p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-left: 0.5rem;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        @media (max-width: 768px) {
            .config-panel, .setup-form {
                margin: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
                min-height: 400px;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
            }
        }
        
        .demo-data {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .demo-data.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .demo-location {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: white;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .demo-location:hover {
            border-color: var(--info-color);
            transform: translateX(5px);
        }
        
        .location-name {
            font-weight: 500;
            color: #333;
        }
        
        .location-count {
            background: var(--success-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 30px;
            text-align: center;
        }
        
        .location-count.zero {
            background: #999;
        }
        
        .location-count.low {
            background: var(--warning-color);
        }
        
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .qr-modal.active {
            display: flex;
        }
        
        .qr-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .instruction-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
        }
        
        .instruction-box h4 {
            color: #1976d2;
            margin-bottom: 0.5rem;
        }
        
        .instruction-box ol {
            margin: 0;
            padding-left: 1.5rem;
            color: #555;
        }
        
        .instruction-box li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="theme-toggle" id="themeToggle">🌙 Dark</button>
        <h1>🗺️ DW Location Tracker v2.1 <span class="live-indicator"></span></h1>
        <div class="status" id="status">Ready to configure</div>
    </div>

    <div class="config-panel" id="mainPanel">
        <div class="quick-start">
            <h4>🚀 Quick Start Guide</h4>
            <p>This version integrates with Google Sheets API to fetch your location data in real-time! Click "Demo Mode" to see it in action, or "Settings" to configure your data sources.</p>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button class="btn" id="initBtn">🚀 Initialize App</button>
            <button class="btn" id="demoBtn">🎮 Demo Mode</button>
            <button class="btn btn-danger" id="setupBtn">⚙️ Settings</button>
            <button class="btn btn-secondary" id="qrBtn" disabled>📱 Generate QR</button>
            <button class="btn btn-secondary" id="refreshBtn" disabled>🔄 Refresh</button>
            <button class="btn btn-warning" id="exportBtn" disabled>📥 Export Data</button>
        </div>
        
        <div class="input-group" style="margin-top: 1rem;">
            <label for="rangeSelector">QR Code Range:</label>
            <select id="rangeSelector">
                <option value="1">1 Mile</option>
                <option value="2">2 Miles</option>
                <option value="3" selected>3 Miles</option>
                <option value="5">5 Miles</option>
                <option value="10">10 Miles</option>
                <option value="all">All Locations</option>
            </select>
        </div>
    </div>

    <div class="setup-form" id="setupForm">
        <h3>⚙️ Configuration Settings</h3>
        
        <div class="instruction-box">
            <h4>✨ Easiest Method - No API Needed!</h4>
            <ol>
                <li>Open your Google Sheet</li>
                <li>Click <strong>File → Share → Publish to web</strong></li>
                <li>Select <strong>Entire Document</strong> and <strong>CSV</strong> format</li>
                <li>Click <strong>Publish</strong> and confirm</li>
                <li>Enter just your Sheet ID below - no API key needed!</li>
            </ol>
        </div>
        
        <div class="input-group">
            <label for="apiKey">Google Maps API Key: <span style="color: red;">*</span></label>
            <input type="password" id="apiKey" placeholder="Enter your Google Maps API key" required>
        </div>
        <div class="input-group">
            <label for="sheetId">Google Sheets ID: <span style="color: red;">*</span></label>
            <input type="text" id="sheetId" placeholder="Enter your Google Sheets ID (from the URL)" required>
            <small style="color: #666;">Find this in: docs.google.com/spreadsheets/d/<strong>[SHEET_ID]</strong>/edit</small>
        </div>
        <div class="input-group">
            <label for="range">Sheet Range:</label>
            <input type="text" id="range" value="Sheet1!A:C" placeholder="e.g., Sheet1!A:C">
            <small style="color: #666;">Leave default if your data starts at A1</small>
        </div>
        
        <div style="margin-top: 1.5rem;">
            <button class="btn" id="saveBtn">💾 Save Configuration</button>
            <button class="btn btn-secondary" id="testBtn">🧪 Test Connection</button>
            <button class="btn btn-secondary" id="cancelBtn">❌ Cancel</button>
            <button class="btn btn-danger" id="clearBtn">🗑️ Clear All Data</button>
        </div>
    </div>

    <div class="map-container">
        <div id="map">
            <div class="map-placeholder" id="mapPlaceholder">
                🗺️ Map will appear here after configuration
            </div>
        </div>
    </div>

    <div class="demo-data" id="demoData">
        <h3>📍 Demo Locations</h3>
        <p style="margin-bottom: 1rem; color: #666;">Sample locations showing how the app works:</p>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Downtown Store</div>
                <div style="color: #666; font-size: 0.9em;">123 Main St, Los Angeles, CA</div>
            </div>
            <div class="location-count">15</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Westside Location</div>
                <div style="color: #666; font-size: 0.9em;">456 Ocean Ave, Santa Monica, CA</div>
            </div>
            <div class="location-count">8</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Hollywood Branch</div>
                <div style="color: #666; font-size: 0.9em;">789 Sunset Blvd, Hollywood, CA</div>
            </div>
            <div class="location-count zero">0</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Beverly Hills Store</div>
                <div style="color: #666; font-size: 0.9em;">321 Rodeo Dr, Beverly Hills, CA</div>
            </div>
            <div class="location-count low">2</div>
        </div>
        
        <div style="margin-top: 1rem;">
            <button class="btn btn-secondary" onclick="generateDemoQR()">
                📱 Generate Demo QR Code
            </button>
            <button class="btn" onclick="exitDemoMode()">
                ✕ Exit Demo Mode
            </button>
        </div>
    </div>

    <div class="qr-modal" id="qrModal">
        <div class="qr-content">
            <h3 id="qrTitle">📱 QR Code</h3>
            <div id="qrCodeDisplay" style="margin: 20px auto;"></div>
            <div id="qrDescription"></div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeQRModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="alert" id="alertDiv" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=places"></script>
    <script>
        // Global variables
        let map;
        let markers = [];
        let userLocation = null;
        let sheetsData = [];
        let isDemoMode = false;
        let isInitialized = false;

        // App state
        const appState = {
            apiKey: '',
            sheetId: '',
            range: 'Sheet1!A:C',
            userId: '',
            initialized: false
        };

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initializeApp();
        });

        // Backup initialization in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // Document still loading, wait for DOMContentLoaded
        } else {
            // Document already loaded
            console.log('Document already loaded, initializing immediately...');
            setTimeout(initializeApp, 100);
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            console.log(`Alert (${type}): ${message}`);
            const alertDiv = document.getElementById('alertDiv');
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.className = `alert ${type}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function updateStatus(message) {
            console.log(`Status: ${message}`);
            document.getElementById('status').textContent = message;
        }

        // Initialize app
        function initializeApp() {
            console.log('Initializing app...');
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '☀️ Light';
            }

            // Load saved configuration
            loadSavedConfiguration();
            
            // Setup event listeners
            setupEventListeners();
            
            updateStatus('Ready to configure - Click Demo Mode or Settings');
            showAlert('Welcome! Click "Demo Mode" to see how it works, or "Settings" to configure your data.', 'info');
        }

        // Load saved configuration
        function loadSavedConfiguration() {
            console.log('Loading saved configuration...');
            const saved = localStorage.getItem('dwLocationConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    Object.assign(appState, config);
                    
                    // Populate form fields
                    if (appState.apiKey) document.getElementById('apiKey').value = appState.apiKey;
                    if (appState.sheetId) document.getElementById('sheetId').value = appState.sheetId;
                    if (appState.range) document.getElementById('range').value = appState.range;
                    
                    updateStatus('Configuration loaded from storage');
                    
                    // Enable buttons if we have configuration
                    if (appState.apiKey && appState.sheetId) {
                        enableButtons();
                    }
                } catch (error) {
                    console.error('Error loading configuration:', error);
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    console.log('Theme toggle clicked');
                    toggleTheme();
                });
            }
            
            // Main buttons
            const initBtn = document.getElementById('initBtn');
            if (initBtn) {
                initBtn.addEventListener('click', function() {
                    console.log('Initialize button clicked');
                    initializeWithConfiguration();
                });
            }
            
            const demoBtn = document.getElementById('demoBtn');
            if (demoBtn) {
                demoBtn.addEventListener('click', function() {
                    console.log('Demo button clicked');
                    toggleDemoMode();
                });
            }
            
            const setupBtn = document.getElementById('setupBtn');
            if (setupBtn) {
                setupBtn.addEventListener('click', function() {
                    console.log('Setup button clicked');
                    toggleSetupForm(true);
                });
            }
            
            const qrBtn = document.getElementById('qrBtn');
            if (qrBtn) {
                qrBtn.addEventListener('click', function() {
                    console.log('QR button clicked');
                    generateQRCode();
                });
            }
            
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    console.log('Refresh button clicked');
                    refreshData();
                });
            }
            
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    console.log('Export button clicked');
                    exportData();
                });
            }
            
            // Setup form buttons
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    console.log('Save button clicked');
                    saveConfiguration();
                });
            }
            
            const testBtn = document.getElementById('testBtn');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    console.log('Test button clicked');
                    testConnection();
                });
            }
            
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    console.log('Cancel button clicked');
                    toggleSetupForm(false);
                });
            }
            
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log('Clear button clicked');
                    clearAllData();
                });
            }
            
            console.log('Event listeners setup complete');
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('themeToggle');
            const isDark = document.body.classList.contains('dark-mode');
            btn.textContent = isDark ? '☀️ Light' : '🌙 Dark';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            showAlert(`Switched to ${isDark ? 'dark' : 'light'} theme`, 'info');
        }

        // Initialize with configuration
        function initializeWithConfiguration() {
            if (!appState.apiKey || !appState.sheetId) {
                showAlert('Please configure your API key and Sheet ID first in Settings', 'warning');
                return;
            }
            
            updateStatus('Initializing with saved configuration...');
            showAlert('Attempting to initialize with saved configuration...', 'info');
            
            // Load Google Maps with the user's API key
            loadGoogleMaps();
            
            // Fetch data from Google Sheets
            fetchSheetsData();
            
            enableButtons();
            isInitialized = true;
            updateStatus('App initialized successfully');
            showAlert('App initialized! Loading map and data...', 'success');
        }

        // Load Google Maps
        function loadGoogleMaps() {
            // Check if API key is valid format
            if (!appState.apiKey || appState.apiKey.length < 20) {
                showAlert('Invalid Google Maps API key format. Please check your API key in Settings.', 'error');
                updateStatus('Invalid API key');
                return;
            }
            
            // Update the Maps API script with the user's API key
            const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (existingScript) {
                existingScript.remove();
            }
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${appState.apiKey}&callback=initMap&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                showAlert('Failed to load Google Maps. Please check your API key and ensure it has the following APIs enabled: Maps JavaScript API, Geocoding API, Places API', 'error');
                updateStatus('Map loading failed - check API key');
            };
            
            document.head.appendChild(script);
        }

        // Initialize Google Map (callback function)
        window.initMap = function() {
            console.log('Initializing Google Map...');
            
            // Default location (Los Angeles)
            const defaultLocation = { lat: 34.0522, lng: -118.2437 };
            
            const mapElement = document.getElementById('map');
            const placeholder = document.getElementById('mapPlaceholder');
            
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            map = new google.maps.Map(mapElement, {
                zoom: 10,
                center: defaultLocation,
                mapTypeId: 'roadmap'
            });
            
            // Get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(userLocation);
                        map.setZoom(12);
                        
                        // Add user location marker
                        new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="8" fill="#4285f4" stroke="white" stroke-width="2"/>
                                        <circle cx="10" cy="10" r="3" fill="white"/>
                                    </svg>
                                `),
                                scaledSize: new google.maps.Size(20, 20)
                            }
                        });
                        
                        showAlert('Map loaded with your location!', 'success');
                        updateStatus('Map ready - showing your location');
                        
                        // Add markers for sheet data if available
                        if (sheetsData.length > 0) {
                            addMarkersToMap();
                        }
                    },
                    function() {
                        showAlert('Could not get your location. Using default location.', 'warning');
                        updateStatus('Map ready - using default location');
                    }
                );
            } else {
                showAlert('Geolocation not supported. Using default location.', 'warning');
                updateStatus('Map ready - using default location');
            }
        };

        // Fetch data from Google Sheets
        async function fetchSheetsData() {
            if (!appState.sheetId) {
                showAlert('No Sheet ID configured', 'error');
                return;
            }
            
            try {
                updateStatus('Fetching data from Google Sheets...');
                
                // Try the public CSV export method first
                const csvUrl = `https://docs.google.com/spreadsheets/d/${appState.sheetId}/export?format=csv`;
                
                console.log('Fetching from URL:', csvUrl);
                
                const response = await fetch(csvUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}. Make sure your Google Sheet is published to web as CSV.`);
                }
                
                const csvText = await response.text();
                console.log('CSV data received:', csvText.substring(0, 500) + '...');
                
                // Parse CSV data with better error handling
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('Sheet appears to be empty or has no data rows');
                }
                
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());
                console.log('Headers found:', headers);
                
                // Validate expected columns
                const nameCol = headers.findIndex(h => h.includes('name') || h.includes('location') || h.includes('store'));
                const addressCol = headers.findIndex(h => h.includes('address') || h.includes('location') || h.includes('addr'));
                const countCol = headers.findIndex(h => h.includes('count') || h.includes('stock') || h.includes('available') || h.includes('qty'));
                
                if (nameCol === -1) {
                    showAlert('Could not find name/location column in your sheet. Expected headers like: Name, Location, Store', 'warning');
                }
                if (addressCol === -1) {
                    showAlert('Could not find address column in your sheet. Expected headers like: Address, Location, Addr', 'warning');
                }
                
                console.log(`Column mapping - Name: ${nameCol}, Address: ${addressCol}, Count: ${countCol}`);
                
                sheetsData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    // Handle CSV parsing with potential commas in quoted fields
                    const values = parseCSVLine(lines[i]);
                    
                    if (values.length >= 2) {
                        const name = (values[nameCol] || values[0] || `Location ${i}`).trim();
                        const address = (values[addressCol] || values[1] || '').trim();
                        const count = parseInt(values[countCol] || values[2] || '0') || 0;
                        
                        // Skip rows with empty/invalid addresses
                        if (!address || address.length < 5) {
                            console.warn(`Skipping row ${i}: Invalid address "${address}"`);
                            continue;
                        }
                        
                        const location = {
                            name: name,
                            address: address,
                            count: count,
                            distance: 0 // Will be calculated later
                        };
                        
                        console.log(`Processing location ${i}:`, location);
                        
                        // Only geocode if we have a proper address
                        if (window.google && window.google.maps) {
                            await geocodeLocation(location);
                        } else {
                            console.warn('Google Maps not loaded yet, skipping geocoding');
                        }
                        
                        sheetsData.push(location);
                    }
                }
                
                console.log('Processed locations:', sheetsData);
                
                updateStatus(`Loaded ${sheetsData.length} locations from Google Sheets`);
                showAlert(`Successfully loaded ${sheetsData.length} locations!`, 'success');
                
                // Add markers to map if map is ready
                if (map && sheetsData.length > 0) {
                    addMarkersToMap();
                } else if (sheetsData.length === 0) {
                    showAlert('No valid locations found in your sheet. Please check your data format.', 'warning');
                }
                
            } catch (error) {
                console.error('Error fetching sheets data:', error);
                showAlert(`Failed to fetch data: ${error.message}`, 'error');
                updateStatus('Failed to load data from Google Sheets');
            }
        }

        // Parse CSV line handling quoted fields with commas
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, '')); // Remove surrounding quotes
        }

        // Geocode location using Google Maps API
        async function geocodeLocation(location) {
            if (!location.address || !window.google || !window.google.maps) {
                console.warn(`Cannot geocode ${location.name}: Missing address or Google Maps not loaded`);
                return;
            }
            
            // Clean up the address
            const cleanAddress = location.address.trim();
            if (cleanAddress.length < 5) {
                console.warn(`Skipping geocoding for ${location.name}: Address too short "${cleanAddress}"`);
                return;
            }
            
            return new Promise((resolve) => {
                const geocoder = new google.maps.Geocoder();
                
                geocoder.geocode({ 
                    address: cleanAddress,
                    componentRestrictions: { country: 'US' } // Restrict to US for better results
                }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        location.position = results[0].geometry.location;
                        
                        // Calculate distance from user location
                        if (userLocation) {
                            location.distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                location.position.lat(), location.position.lng()
                            );
                        }
                        
                        console.log(`✓ Geocoded ${location.name}: ${location.position.toString()}, Distance: ${location.distance.toFixed(1)}mi`);
                    } else {
                        console.warn(`✗ Geocoding failed for ${location.name} (${cleanAddress}): ${status}`);
                        
                        // Provide helpful error messages
                        if (status === 'ZERO_RESULTS') {
                            console.warn(`  → No results found. Check if "${cleanAddress}" is a valid address.`);
                        } else if (status === 'OVER_QUERY_LIMIT') {
                            console.warn('  → Geocoding quota exceeded. Try again later.');
                        } else if (status === 'REQUEST_DENIED') {
                            console.warn('  → Geocoding request denied. Check API key permissions.');
                        }
                    }
                    resolve();
                });
            });
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Add markers to map
        function addMarkersToMap() {
            if (!map || !sheetsData.length) {
                console.log('Map or data not ready for markers');
                return;
            }
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            console.log(`Adding ${sheetsData.length} markers to map`);
            
            sheetsData.forEach((location, index) => {
                if (!location.position) {
                    console.warn(`No position for ${location.name}, skipping marker`);
                    return;
                }
                
                // Create marker
                const marker = new google.maps.Marker({
                    position: location.position,
                    map: map,
                    title: `${location.name}\nAvailable: ${location.count}\nDistance: ${location.distance.toFixed(1)} mi`,
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="40" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 0C6.7 0 0 6.7 0 15c0 15 15 25 15 25s15-10 15-25c0-8.3-6.7-15-15-15z" 
                                      fill="${location.count > 0 ? '#4CAF50' : '#999'}"/>
                                <circle cx="15" cy="15" r="8" fill="white"/>
                                <text x="15" y="20" text-anchor="middle" font-size="10" font-weight="bold" fill="black">${location.count}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 40)
                    }
                });
                
                // Create info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${location.name}</h3>
                            <p style="margin: 5px 0; color: #666;"><strong>Address:</strong> ${location.address}</p>
                            <p style="margin: 5px 0; color: #666;"><strong>Available:</strong> ${location.count}</p>
                            <p style="margin: 5px 0; color: #666;"><strong>Distance:</strong> ${location.distance.toFixed(1)} miles</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location.address)}" 
                               target="_blank" style="color: #1976d2; text-decoration: none;">Get Directions</a>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                if (userLocation) {
                    bounds.extend(userLocation);
                }
                map.fitBounds(bounds);
                
                // Don't zoom in too much for single location
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    if (map.getZoom() > 15) {
                        map.setZoom(15);
                    }
                });
            }
            
            showAlert(`${markers.length} locations displayed on map`, 'success');
        }

        // Save configuration
        function saveConfiguration() {
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                sheetId: document.getElementById('sheetId').value.trim(),
                range: document.getElementById('range').value.trim() || 'Sheet1!A:C'
            };

            if (!config.apiKey || !config.sheetId) {
                showAlert('Please enter both Google Maps API Key and Sheets ID', 'error');
                return false;
            }

            Object.assign(appState, config);
            localStorage.setItem('dwLocationConfig', JSON.stringify(config));
            showAlert('Configuration saved successfully!', 'success');
            
            toggleSetupForm(false);
            enableButtons();
            updateStatus('Configuration saved - ready to initialize');
            
            return true;
        }

        // Test connection
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sheetId = document.getElementById('sheetId').value.trim();
            
            if (!apiKey || !sheetId) {
                showAlert('Please enter API key and Sheet ID first', 'error');
                return;
            }
            
            if (apiKey.length < 20 || !apiKey.startsWith('AIza')) {
                showAlert('API key format appears invalid. Google Maps API keys start with "AIza" and are about 39 characters long.', 'error');
                return;
            }

            try {
                updateStatus('Testing connection...');
                showAlert('Testing connections...', 'info');
                
                // Test 1: Google Sheets access
                console.log('Testing Google Sheets access...');
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                const sheetResponse = await fetch(csvUrl);
                
                if (!sheetResponse.ok) {
                    throw new Error(`Google Sheets test failed (${sheetResponse.status}). Make sure your sheet is published to web as CSV.`);
                }
                
                const csvText = await sheetResponse.text();
                if (csvText.includes('<!DOCTYPE html>')) {
                    throw new Error('Sheet returned HTML instead of CSV. Make sure it\'s published as CSV, not web page.');
                }
                
                const lines = csvText.trim().split('\n');
                console.log(`✓ Google Sheets: Found ${lines.length} rows`);
                console.log('Sample data:', lines[0]);
                
                // Test 2: Google Maps API (basic validation)
                console.log('Testing Google Maps API...');
                const mapsTestUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=1600+Amphitheatre+Parkway,+Mountain+View,+CA&key=${apiKey}`;
                const mapsResponse = await fetch(mapsTestUrl);
                const mapsResult = await mapsResponse.json();
                
                if (mapsResult.status === 'REQUEST_DENIED') {
                    throw new Error('Google Maps API key is invalid or doesn\'t have Geocoding API enabled.');
                } else if (mapsResult.status === 'OVER_QUERY_LIMIT') {
                    throw new Error('Google Maps API quota exceeded.');
                } else if (mapsResult.error_message) {
                    throw new Error(`Google Maps API error: ${mapsResult.error_message}`);
                }
                
                console.log('✓ Google Maps API: Working');
                
                showAlert('✅ All connections successful! You can now initialize the app.', 'success');
                updateStatus('All connections verified');
                
                // Show data preview
                if (lines.length > 1) {
                    const preview = lines.slice(0, 3).join('\n');
                    console.log('Data preview:', preview);
                    showAlert(`Found ${lines.length - 1} data rows. Preview:\n${lines[0]}`, 'info');
                }
                
            } catch (error) {
                console.error('Connection test failed:', error);
                showAlert(`❌ Connection test failed: ${error.message}`, 'error');
                updateStatus('Connection test failed');
            }
        }

        // Enable buttons after configuration
        function enableButtons() {
            document.getElementById('qrBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            
            // Update initialize button text but keep it functional
            const initBtn = document.getElementById('initBtn');
            if (initBtn) {
                initBtn.textContent = '✅ Re-initialize';
                initBtn.disabled = false;
            }
        }

        // Toggle setup form
        function toggleSetupForm(show = null) {
            console.log('toggleSetupForm called with show =', show);
            
            const form = document.getElementById('setupForm');
            const panel = document.getElementById('mainPanel');
            const demoData = document.getElementById('demoData');
            
            console.log('Form element:', form);
            console.log('Panel element:', panel);
            
            if (!form || !panel) {
                console.error('Required elements not found!');
                showAlert('Error: UI elements not found', 'error');
                return;
            }
            
            if (show === null) {
                show = !form.classList.contains('active');
            }
            
            console.log('Setting form active to:', show);
            
            form.classList.toggle('active', show);
            panel.style.display = show ? 'none' : 'block';
            
            if (demoData) {
                demoData.classList.remove('active');
            }
            
            if (show) {
                updateStatus('Configuration panel open');
                showAlert('Configuration panel opened', 'info');
            } else {
                updateStatus('Configuration panel closed');
            }
        }

        // Toggle demo mode
        function toggleDemoMode() {
            isDemoMode = !isDemoMode;
            const demoData = document.getElementById('demoData');
            const setupForm = document.getElementById('setupForm');
            const mainPanel = document.getElementById('mainPanel');
            
            if (isDemoMode) {
                demoData.classList.add('active');
                setupForm.classList.remove('active');
                mainPanel.style.display = 'none';
                updateStatus('Demo mode active - Showing sample data');
                enableButtons();
                showAlert('Demo mode activated! This shows how the app works with sample data.', 'info');
            } else {
                exitDemoMode();
            }
        }

        // Exit demo mode
        function exitDemoMode() {
            isDemoMode = false;
            const demoData = document.getElementById('demoData');
            const mainPanel = document.getElementById('mainPanel');
            
            demoData.classList.remove('active');
            mainPanel.style.display = 'block';
            updateStatus('Demo mode disabled');
            showAlert('Demo mode disabled', 'info');
        }

        // Generate QR code
        function generateQRCode() {
            console.log('generateQRCode called');
            console.log('isDemoMode:', isDemoMode);
            console.log('appState:', appState);
            console.log('sheetsData:', sheetsData);
            
            if (isDemoMode) {
                console.log('Generating demo QR');
                generateDemoQR();
                return;
            }
            
            if (!appState.apiKey || !appState.sheetId) {
                console.log('Missing configuration');
                showAlert('Please configure your settings first', 'warning');
                return;
            }
            
            if (!sheetsData || sheetsData.length === 0) {
                console.log('No data available, generating sample QR');
                // Generate a sample QR with the configured sheet
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=locations+near+me`;
                showQRModal(
                    '📱 Sample QR Code',
                    mapsUrl,
                    'No location data loaded yet. This is a sample QR code. Please initialize the app first to load your real data.'
                );
                showAlert('Sample QR generated. Initialize the app to load real data.', 'warning');
                return;
            }
            
            // Get selected range
            const rangeValue = document.getElementById('rangeSelector').value;
            const selectedRange = rangeValue === 'all' ? Infinity : parseFloat(rangeValue);
            
            console.log('Selected range:', selectedRange);
            
            // Filter locations within selected range
            let nearbyLocations = sheetsData;
            if (selectedRange !== Infinity) {
                nearbyLocations = sheetsData.filter(location => location.distance <= selectedRange);
            }
            
            console.log('Nearby locations:', nearbyLocations);
            
            if (nearbyLocations.length === 0) {
                showAlert(`No locations found within ${selectedRange} miles`, 'warning');
                return;
            }
            
            // Create Google Maps URL with the nearby locations
            let mapsUrl = '';
            
            if (nearbyLocations.length === 1) {
                // Single location - direct navigation
                const location = nearbyLocations[0];
                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location.address)}&travelmode=driving`;
            } else {
                // Multiple locations - create search URL
                const searchQuery = nearbyLocations
                    .map(loc => `${loc.name} ${loc.address}`)
                    .join(' OR ');
                mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
            }
            
            const rangeText = selectedRange === Infinity ? 'All' : selectedRange + ' Mile';
            const description = `
                <p style="color: #666; margin: 1rem 0;">
                    Found ${nearbyLocations.length} location${nearbyLocations.length > 1 ? 's' : ''} within ${rangeText} range:
                </p>
                <div style="max-height: 200px; overflow-y: auto; text-align: left; margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                    <ul style="margin: 0; padding-left: 20px;">
                        ${nearbyLocations
                            .sort((a, b) => a.distance - b.distance)
                            .map(loc => `
                                <li style="margin: 5px 0;">
                                    <strong>${loc.name}</strong> (${loc.distance.toFixed(1)} mi)<br>
                                    <span style="color: #666; font-size: 0.9em;">
                                        ${loc.address} - Available: ${loc.count}
                                    </span>
                                </li>
                            `).join('')}
                    </ul>
                </div>
            `;
            
            console.log('Showing QR modal with URL:', mapsUrl);
            
            showQRModal(
                `📱 ${rangeText} Range QR Code`,
                mapsUrl,
                description
            );
            
            showAlert(`QR code generated for ${nearbyLocations.length} locations within ${rangeText} range!`, 'success');
        }

        // Generate demo QR code
        function generateDemoQR() {
            const demoLocations = [
                'Downtown Store, 123 Main St, Los Angeles, CA',
                'Westside Location, 456 Ocean Ave, Santa Monica, CA',
                'Hollywood Branch, 789 Sunset Blvd, Hollywood, CA',
                'Beverly Hills Store, 321 Rodeo Dr, Beverly Hills, CA'
            ];
            
            const searchQuery = demoLocations.join(' OR ');
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
            
            showQRModal(
                '📱 Demo QR Code',
                mapsUrl,
                'Scan to see demo locations in Google Maps. This shows 4 sample locations in the LA area.'
            );
            
            showAlert('Demo QR code generated!', 'success');
        }

        // Show QR modal
        function showQRModal(title, url, description) {
            console.log('showQRModal called with:', title, url);
            
            const modal = document.getElementById('qrModal');
            const titleEl = document.getElementById('qrTitle');
            const displayEl = document.getElementById('qrCodeDisplay');
            const descEl = document.getElementById('qrDescription');
            
            if (!modal || !titleEl || !displayEl || !descEl) {
                console.error('QR Modal elements not found!');
                showAlert('Error: QR modal elements not found', 'error');
                return;
            }
            
            console.log('Setting modal content...');
            
            titleEl.textContent = title;
            descEl.innerHTML = `${description}
                               <a href="${url}" target="_blank" class="btn btn-secondary" style="margin: 0.5rem;">
                                   📍 Test in Google Maps
                               </a>`;
            
            // Clear previous QR code
            displayEl.innerHTML = '';
            
            console.log('Generating QR code...');
            
            // Check if QRCode is available
            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded!');
                displayEl.innerHTML = '<p style="color: red;">QR Code library failed to load</p>';
                showAlert('QR Code library not available', 'error');
                return;
            }
            
            try {
                // Generate new QR code
                new QRCode(displayEl, {
                    text: url,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                console.log('QR code generated successfully');
            } catch (error) {
                console.error('Error generating QR code:', error);
                displayEl.innerHTML = `<p style="color: red;">Error generating QR code: ${error.message}</p>`;
                showAlert('Failed to generate QR code', 'error');
                return;
            }
            
            console.log('Showing modal...');
            modal.classList.add('active');
            
            // Make sure modal is visible
            modal.style.display = 'flex';
            
            showAlert('QR code generated successfully!', 'success');
        }

        // Close QR modal
        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('active');
        }

        // Refresh data
        function refreshData() {
            if (isDemoMode) {
                showAlert('Demo data refreshed! (Simulated)', 'success');
                updateStatus('Demo data refreshed');
                return;
            }
            
            if (!appState.apiKey || !appState.sheetId) {
                showAlert('Please configure your settings first', 'warning');
                return;
            }
            
            updateStatus('Refreshing data...');
            showAlert('Refreshing data from Google Sheets...', 'info');
            
            // Fetch fresh data from Google Sheets
            fetchSheetsData();
        }

        // Export data
        function exportData() {
            if (isDemoMode) {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Name,Address,Count\n"
                    + "Downtown Store,123 Main St Los Angeles CA,15\n"
                    + "Westside Location,456 Ocean Ave Santa Monica CA,8\n"
                    + "Hollywood Branch,789 Sunset Blvd Hollywood CA,0\n"
                    + "Beverly Hills Store,321 Rodeo Dr Beverly Hills CA,2";
                
                downloadCSV(csvContent, "demo_locations.csv");
                showAlert('Demo data exported!', 'success');
                return;
            }
            
            if (!appState.apiKey || !appState.sheetId) {
                showAlert('Please configure your settings first', 'warning');
                return;
            }
            
            // Simulate export for configured mode
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Name,Address,Count\n"
                + "Sample Location 1,Sample Address 1,10\n"
                + "Sample Location 2,Sample Address 2,5";
            
            downloadCSV(csvContent, "locations_export.csv");
            showAlert('Data exported successfully!', 'success');
        }

        // Download CSV helper
        function downloadCSV(csvContent, filename) {
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all configuration data?')) {
                localStorage.clear();
                showAlert('All data cleared! Page will reload.', 'info');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        }

        // Global functions for onclick handlers
        window.generateDemoQR = generateDemoQR;
        window.exitDemoMode = exitDemoMode;
        window.closeQRModal = closeQRModal;

        // Initialize everything
        console.log('Script loaded, waiting for DOM...');
    </script>
</body>
</html>
