<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DW Location Tracker - v2.1 with Sheets Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #f44336;
            --info-color: #2196F3;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        body.dark-mode {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            color: white;
            border-bottom: 1px solid var(--glass-border);
            position: relative;
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .config-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .config-panel h3 {
            color: white;
            margin-bottom: 1rem;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--success-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .btn {
            background: linear-gradient(45deg, var(--success-color), #45a049);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, var(--info-color), #1976D2);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #d32f2f);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #f57c00);
        }
        
        .map-container {
            flex: 1;
            margin: 1rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-height: 500px;
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        
        .map-placeholder {
            color: white;
            text-align: center;
            font-size: 1.2rem;
            opacity: 0.7;
        }
        
        .alert {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            color: var(--warning-color);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .alert.success {
            background: rgba(76, 175, 80, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
            color: var(--success-color);
        }
        
        .alert.error {
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
            color: var(--danger-color);
        }
        
        .alert.info {
            background: rgba(33, 150, 243, 0.1);
            border-color: rgba(33, 150, 243, 0.3);
            color: var(--info-color);
        }
        
        .setup-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .setup-form.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .setup-form h3 {
            margin-bottom: 1.5rem;
            color: #333;
        }
        
        .setup-form input,
        .setup-form select {
            background: white;
            border: 2px solid #ddd;
            color: #333;
        }
        
        .setup-form input:focus,
        .setup-form select:focus {
            border-color: var(--success-color);
        }
        
        .quick-start {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success-color);
        }
        
        .quick-start h4 {
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .quick-start p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-left: 0.5rem;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        @media (max-width: 768px) {
            .config-panel, .setup-form {
                margin: 0.5rem;
            }
            
            .map-container {
                margin: 0.5rem;
                min-height: 400px;
            }
            
            .theme-toggle {
                position: static;
                margin-top: 1rem;
            }
        }
        
        .demo-data {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .demo-data.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        .demo-location {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: white;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .demo-location:hover {
            border-color: var(--info-color);
            transform: translateX(5px);
        }
        
        .location-name {
            font-weight: 500;
            color: #333;
        }
        
        .location-count {
            background: var(--success-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 30px;
            text-align: center;
        }
        
        .location-count.zero {
            background: #999;
        }
        
        .location-count.low {
            background: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="theme-toggle" id="themeToggle">üåô Dark</button>
        <h1>üó∫Ô∏è DW Location Tracker v2.1 <span class="live-indicator"></span></h1>
        <div class="status" id="status">Ready to configure</div>
    </div>

    <div class="config-panel" id="mainPanel">
        <div class="quick-start">
            <h4>üöÄ Quick Start Guide</h4>
            <p>This version integrates with Google Sheets API to fetch your location data in real-time! Click "Demo Mode" to see it in action, or "Settings" to configure your data sources.</p>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <button class="btn" id="demoBtn">üéÆ Demo Mode</button>
            <button class="btn btn-danger" id="setupBtn">‚öôÔ∏è Settings</button>
            <button class="btn btn-secondary" id="qrBtn" disabled>üì± Generate QR</button>
            <button class="btn btn-secondary" id="refreshBtn" disabled>üîÑ Refresh</button>
            <button class="btn btn-warning" id="exportBtn" disabled>üì• Export Data</button>
        </div>
        
        <div class="input-group" style="margin-top: 1rem;">
            <label for="rangeSelector">QR Code Range:</label>
            <select id="rangeSelector">
                <option value="1">1 Mile</option>
                <option value="2">2 Miles</option>
                <option value="3" selected>3 Miles</option>
                <option value="5">5 Miles</option>
                <option value="10">10 Miles</option>
                <option value="all">All Locations</option>
            </select>
        </div>
    </div>

    <div class="setup-form" id="setupForm">
        <h3>‚öôÔ∏è Configuration Settings</h3>
        
        <div style="background: #c8e6c9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #4CAF50;">
            <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">‚ú® Easiest Method - No API Needed!</h4>
            <ol style="margin: 0; padding-left: 1.5rem; color: #333; font-size: 0.9rem;">
                <li>Open your Google Sheet</li>
                <li>Click <strong>File ‚Üí Share ‚Üí Publish to web</strong></li>
                <li>Select <strong>Entire Document</strong> and <strong>CSV</strong> format</li>
                <li>Click <strong>Publish</strong> and confirm</li>
                <li>Enter just your Sheet ID below - no API key needed!</li>
            </ol>
        </div>
        
        <div class="input-group">
            <label for="apiKey">Google Maps API Key: <span style="color: red;">*</span></label>
            <input type="password" id="apiKey" placeholder="Enter your Google Maps API key" required>
        </div>
        <div class="input-group">
            <label for="sheetId">Google Sheets ID: <span style="color: red;">*</span></label>
            <input type="text" id="sheetId" placeholder="Enter your Google Sheets ID (from the URL)" required>
            <small style="color: #666;">Find this in: docs.google.com/spreadsheets/d/<strong>[SHEET_ID]</strong>/edit</small>
        </div>
        <div class="input-group">
            <label for="range">Sheet Range:</label>
            <input type="text" id="range" value="Sheet1!A:C" placeholder="e.g., Sheet1!A:C">
            <small style="color: #666;">Leave default if your data starts at A1</small>
        </div>
        
        <button class="btn" id="saveBtn">üíæ Save Configuration</button>
        <button class="btn btn-secondary" id="testBtn">üß™ Test Connection</button>
        <button class="btn btn-secondary" id="cancelBtn">‚ùå Cancel</button>
        <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Clear All Data</button>
    </div>

    <div class="map-container">
        <div id="map">
            <div class="map-placeholder">
                üó∫Ô∏è Map will appear here after configuration
            </div>
        </div>
    </div>

    <div class="demo-data" id="demoData">
        <h3>üìç Demo Locations</h3>
        <p style="margin-bottom: 1rem; color: #666;">Sample locations showing how the app works:</p>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Downtown Store</div>
                <div style="color: #666; font-size: 0.9em;">123 Main St, Los Angeles, CA</div>
            </div>
            <div class="location-count">15</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Westside Location</div>
                <div style="color: #666; font-size: 0.9em;">456 Ocean Ave, Santa Monica, CA</div>
            </div>
            <div class="location-count">8</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Hollywood Branch</div>
                <div style="color: #666; font-size: 0.9em;">789 Sunset Blvd, Hollywood, CA</div>
            </div>
            <div class="location-count zero">0</div>
        </div>
        
        <div class="demo-location">
            <div>
                <div class="location-name">Beverly Hills Store</div>
                <div style="color: #666; font-size: 0.9em;">321 Rodeo Dr, Beverly Hills, CA</div>
            </div>
            <div class="location-count low">2</div>
        </div>
        
        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="generateDemoQR()">
            üì± Generate Demo QR Code
        </button>
    </div>

    <div class="alert" id="alertDiv" style="display: none;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Global variables
        let map;
        let markers = [];
        let userLocation = null;
        let sheetsData = [];
        let isDemoMode = false;

        // App state
        const appState = {
            apiKey: '',
            sheetId: '',
            range: 'Sheet1!A:C',
            userId: '',
            initialized: false
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadSavedConfiguration();
            setupEventListeners();
            updateStatus('Ready to configure - Click Demo Mode or Settings');
        });

        // Utility functions
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alertDiv');
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            alertDiv.className = `alert ${type}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Theme toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('themeToggle');
            const isDark = document.body.classList.contains('dark-mode');
            btn.textContent = isDark ? '‚òÄÔ∏è Light' : 'üåô Dark';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Initialize app
        function initializeApp() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light';
            }
        }

        // Load saved configuration
        function loadSavedConfiguration() {
            const saved = localStorage.getItem('dwLocationConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    Object.assign(appState, config);
                    
                    // Populate form fields
                    if (appState.apiKey) document.getElementById('apiKey').value = appState.apiKey;
                    if (appState.sheetId) document.getElementById('sheetId').value = appState.sheetId;
                    if (appState.range) document.getElementById('range').value = appState.range;
                    
                    updateStatus('Configuration loaded from storage');
                } catch (error) {
                    console.error('Error loading configuration:', error);
                }
            }
        }

        // Save configuration
        function saveConfiguration() {
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                sheetId: document.getElementById('sheetId').value.trim(),
                range: document.getElementById('range').value.trim() || 'Sheet1!A:C'
            };

            if (!config.apiKey || !config.sheetId) {
                showAlert('Please enter both Google Maps API Key and Sheets ID', 'error');
                return false;
            }

            Object.assign(appState, config);
            localStorage.setItem('dwLocationConfig', JSON.stringify(config));
            showAlert('Configuration saved successfully!', 'success');
            
            toggleSetupForm(false);
            enableButtons();
            
            return true;
        }

        // Test connection
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const sheetId = document.getElementById('sheetId').value.trim();
            
            if (!apiKey || !sheetId) {
                showAlert('Please enter API key and Sheet ID first', 'error');
                return;
            }

            try {
                updateStatus('Testing connection...');
                
                // Test Google Maps API
                const mapsTest = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=test&key=${apiKey}`);
                const mapsResult = await mapsTest.json();
                
                if (mapsResult.status === 'REQUEST_DENIED') {
                    throw new Error('Google Maps API key is invalid or restricted');
                }

                // Test Google Sheets (public access)
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
                const sheetTest = await fetch(csvUrl);
                
                if (!sheetTest.ok) {
                    throw new Error('Cannot access Google Sheet. Make sure it\'s published to web as CSV');
                }

                showAlert('Connection test successful!', 'success');
                updateStatus('Connection verified');
                
            } catch (error) {
                showAlert(`Connection test failed: ${error.message}`, 'error');
                updateStatus('Connection failed');
            }
        }

        // Enable buttons after configuration
        function enableButtons() {
            document.getElementById('qrBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        }

        // Toggle setup form
        function toggleSetupForm(show = null) {
            const form = document.getElementById('setupForm');
            const panel = document.getElementById('mainPanel');
            const demoData = document.getElementById('demoData');
            
            if (show === null) {
                show = !form.classList.contains('active');
            }
            
            form.classList.toggle('active', show);
            panel.style.display = show ? 'none' : 'block';
            demoData.classList.remove('active');
        }

        // Toggle demo mode
        function toggleDemoMode() {
            isDemoMode = !isDemoMode;
            const demoData = document.getElementById('demoData');
            const setupForm = document.getElementById('setupForm');
            const mainPanel = document.getElementById('mainPanel');
            
            if (isDemoMode) {
                demoData.classList.add('active');
                setupForm.classList.remove('active');
                mainPanel.style.display = 'none';
                updateStatus('Demo mode active - Showing sample data');
                enableButtons();
                showAlert('Demo mode activated! This shows how the app works with sample data.', 'info');
            } else {
                demoData.classList.remove('active');
                mainPanel.style.display = 'block';
                updateStatus('Demo mode disabled');
            }
        }

        // Generate demo QR code
        function generateDemoQR() {
            const demoLocations = [
                'Downtown Store, 123 Main St, Los Angeles, CA',
                'Westside Location, 456 Ocean Ave, Santa Monica, CA',
                'Hollywood Branch, 789 Sunset Blvd, Hollywood, CA',
                'Beverly Hills Store, 321 Rodeo Dr, Beverly Hills, CA'
            ];
            
            const searchQuery = demoLocations.join(' OR ');
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
            
            // Create QR container if it doesn't exist
            let qrContainer = document.getElementById('qrContainer');
            if (!qrContainer) {
                qrContainer = document.createElement('div');
                qrContainer.id = 'qrContainer';
                qrContainer.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    margin: 1rem;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                    text-align: center;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 1000;
                    max-width: 400px;
                `;
                document.body.appendChild(qrContainer);
            }
            
            qrContainer.innerHTML = `
                <h3>üì± Demo QR Code</h3>
                <div id="qrCodeDisplay" style="margin: 20px auto;"></div>
                <p style="color: #666; margin: 1rem 0;">Scan to see demo locations in Google Maps</p>
                <button onclick="document.getElementById('qrContainer').remove()" 
                        style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            `;
            
            qrContainer.style.display = 'block';
            
            // Generate QR code
            new QRCode(document.getElementById('qrCodeDisplay'), {
                text: mapsUrl,
                width: 200,
                height: 200,
                colorDark: '#000000',
                colorLight: '#ffffff'
            });
            
            showAlert('Demo QR code generated!', 'success');
        }

        // Export demo data
        function exportData() {
            if (isDemoMode) {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Name,Address,Count\n"
                    + "Downtown Store,123 Main St Los Angeles CA,15\n"
                    + "Westside Location,456 Ocean Ave Santa Monica CA,8\n"
                    + "Hollywood Branch,789 Sunset Blvd Hollywood CA,0\n"
                    + "Beverly Hills Store,321 Rodeo Dr Beverly Hills CA,2";
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "demo_locations.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('Demo data exported!', 'success');
            } else {
                showAlert('Configure real data source first', 'warning');
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all configuration data?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Main buttons
            document.getElementById('demoBtn').addEventListener('click', toggleDemoMode);
            document.getElementById('setupBtn').addEventListener('click', () => toggleSetupForm(true));
            document.getElementById('qrBtn').addEventListener('click', generateDemoQR);
            document.getElementById('refreshBtn').addEventListener('click', () => showAlert('Refresh functionality ready for real data', 'info'));
            document.getElementById('exportBtn').addEventListener('click', exportData);
            
            // Setup form buttons
            document.getElementById('saveBtn').addEventListener('click', saveConfiguration);
            document.getElementById('testBtn').addEventListener('click', testConnection);
            document.getElementById('cancelBtn').addEventListener('click', () => toggleSetupForm(false));
            document.getElementById('clearBtn').addEventListener('click', clearAllData);
        }

        // Initialize everything when page loads
        updateStatus('Application initialized successfully');
    </script>
</body>
</html>
