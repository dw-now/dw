// Google Apps Script - Auto-sync Google Sheets to Google My Maps
// Add this script to your Google Sheet via Extensions > Apps Script

// ============= CONFIGURATION =============
const CONFIG = {
  // Your Google My Maps ID (get from the map URL)
  MAP_ID: 'YOUR_MAP_ID_HERE', // Found in URL: mymaps.google.com/maps/d/edit?mid=MAP_ID
  
  // Your Sheet configuration
  SHEET_NAME: 'Sheet1',
  NAME_COLUMN: 1,      // Column A
  ADDRESS_COLUMN: 2,   // Column B  
  COUNT_COLUMN: 3,     // Column C
  
  // Optional: Additional columns
  PHONE_COLUMN: 4,     // Column D (if exists)
  HOURS_COLUMN: 5,     // Column E (if exists)
  
  // Auto-refresh interval (in minutes)
  REFRESH_INTERVAL: 30
};

// ============= MAIN FUNCTIONS =============

/**
 * Initial setup - Run this once to set up triggers
 */
function setupAutoSync() {
  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // Create new time-based trigger
  ScriptApp.newTrigger('syncSheetToMap')
    .timeBased()
    .everyMinutes(CONFIG.REFRESH_INTERVAL)
    .create();
  
  // Also create an on-edit trigger for immediate updates
  ScriptApp.newTrigger('onSheetEdit')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit()
    .create();
  
  // Run initial sync
  syncSheetToMap();
  
  SpreadsheetApp.getUi().alert('‚úÖ Auto-sync setup complete! Your map will update every ' + CONFIG.REFRESH_INTERVAL + ' minutes.');
}

/**
 * Manual sync function - Run this to sync immediately
 */
function syncSheetToMap() {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    
    // Skip header row if it exists
    const hasHeader = isNaN(parseInt(data[0][CONFIG.COUNT_COLUMN - 1]));
    const startRow = hasHeader ? 1 : 0;
    
    // Prepare locations array
    const locations = [];
    
    for (let i = startRow; i < data.length; i++) {
      const row = data[i];
      const name = row[CONFIG.NAME_COLUMN - 1];
      const address = row[CONFIG.ADDRESS_COLUMN - 1];
      const count = row[CONFIG.COUNT_COLUMN - 1];
      
      if (name && address) {
        const location = {
          name: name.toString().trim(),
          address: address.toString().trim(),
          count: parseInt(count) || 0,
          // Add color coding based on availability
          markerColor: getMarkerColor(parseInt(count) || 0),
          description: `Available: ${count}`
        };
        
        // Add optional fields if they exist
        if (CONFIG.PHONE_COLUMN && row[CONFIG.PHONE_COLUMN - 1]) {
          location.phone = row[CONFIG.PHONE_COLUMN - 1];
        }
        if (CONFIG.HOURS_COLUMN && row[CONFIG.HOURS_COLUMN - 1]) {
          location.hours = row[CONFIG.HOURS_COLUMN - 1];
        }
        
        locations.push(location);
      }
    }
    
    // Update Google My Maps
    updateMyMap(locations);
    
    // Log success
    console.log(`Synced ${locations.length} locations to map`);
    
    // Update last sync time in sheet
    updateLastSyncTime();
    
  } catch (error) {
    console.error('Sync error:', error);
    SpreadsheetApp.getUi().alert('‚ùå Sync failed: ' + error.message);
  }
}

/**
 * On edit trigger - Syncs when sheet is edited
 */
function onSheetEdit(e) {
  // Only sync if edit was in the data columns
  const range = e.range;
  const sheet = range.getSheet();
  
  if (sheet.getName() === CONFIG.SHEET_NAME) {
    // Debounce - wait 2 seconds before syncing to avoid multiple rapid syncs
    Utilities.sleep(2000);
    syncSheetToMap();
  }
}

/**
 * Update Google My Maps with new data
 */
function updateMyMap(locations) {
  // Method 1: Using Maps API (Recommended)
  const mapsUrl = `https://www.google.com/maps/d/u/0/edit?mid=${CONFIG.MAP_ID}`;
  
  // Create KML format for import
  const kml = createKML(locations);
  
  // Save KML to Drive
  const blob = Utilities.newBlob(kml, 'application/vnd.google-earth.kml+xml', 'locations.kml');
  const file = DriveApp.createFile(blob);
  
  // Get the file URL
  const fileUrl = file.getUrl();
  
  // Note: Full automation requires Maps API access
  // For now, we'll create an importable file and notify user
  
  // Create import instructions
  const htmlOutput = HtmlService.createHtmlOutput(`
    <div style="font-family: Arial, sans-serif; padding: 20px;">
      <h2>üó∫Ô∏è Map Update Ready!</h2>
      <p><strong>${locations.length} locations</strong> processed from your sheet.</p>
      
      <h3>Option 1: Auto-Import (Recommended)</h3>
      <ol>
        <li>Open your <a href="${mapsUrl}" target="_blank">Google My Map</a></li>
        <li>Click "Import" layer</li>
        <li>Select "Google Drive" and search for "locations.kml"</li>
        <li>Import will happen automatically</li>
      </ol>
      
      <h3>Option 2: Direct Link</h3>
      <p><a href="${fileUrl}" target="_blank">Download KML file</a> and import manually</p>
      
      <p style="color: green; margin-top: 20px;">‚úÖ Next auto-sync in ${CONFIG.REFRESH_INTERVAL} minutes</p>
    </div>
  `).setWidth(400).setHeight(300);
  
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Map Sync Status');
  
  // Clean up old KML files
  cleanupOldFiles();
}

/**
 * Create KML format for Google My Maps
 */
function createKML(locations) {
  let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>DW Locations</name>
    <description>Auto-synced from Google Sheets</description>
    
    <!-- Define styles for different availability levels -->
    <Style id="available">
      <IconStyle>
        <color>ff00ff00</color>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="low">
      <IconStyle>
        <color>ff00a5ff</color>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
        </Icon>
      </IconStyle>
    </Style>
    
    <Style id="unavailable">
      <IconStyle>
        <color>ff0000ff</color>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
        </Icon>
      </IconStyle>
    </Style>
`;
  
  // Add each location as a placemark
  locations.forEach(location => {
    const styleId = location.count === 0 ? 'unavailable' : 
                    location.count <= 5 ? 'low' : 'available';
    
    kml += `
    <Placemark>
      <name>${escapeXml(location.name)}</name>
      <description><![CDATA[
        <div>
          <p><strong>Address:</strong> ${location.address}</p>
          <p><strong>Available:</strong> ${location.count}</p>
          ${location.phone ? `<p><strong>Phone:</strong> ${location.phone}</p>` : ''}
          ${location.hours ? `<p><strong>Hours:</strong> ${location.hours}</p>` : ''}
          <p><em>Last updated: ${new Date().toLocaleString()}</em></p>
        </div>
      ]]></description>
      <styleUrl>#${styleId}</styleUrl>
      <address>${escapeXml(location.address)}</address>
    </Placemark>`;
  });
  
  kml += `
  </Document>
</kml>`;
  
  return kml;
}

/**
 * Get marker color based on availability
 */
function getMarkerColor(count) {
  if (count === 0) return 'red';
  if (count <= 5) return 'yellow';
  return 'green';
}

/**
 * Escape XML special characters
 */
function escapeXml(text) {
  return text.toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

/**
 * Update last sync timestamp in sheet
 */
function updateLastSyncTime() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(CONFIG.SHEET_NAME);
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  
  // Add timestamp in corner of sheet
  sheet.getRange(lastRow + 2, 1).setValue('Last Sync:');
  sheet.getRange(lastRow + 2, 2).setValue(new Date().toLocaleString());
}

/**
 * Clean up old KML files from Drive
 */
function cleanupOldFiles() {
  const files = DriveApp.getFilesByName('locations.kml');
  const filesToKeep = 3; // Keep last 3 versions
  const fileList = [];
  
  while (files.hasNext()) {
    fileList.push(files.next());
  }
  
  // Sort by date (newest first)
  fileList.sort((a, b) => b.getDateCreated() - a.getDateCreated());
  
  // Delete old files
  for (let i = filesToKeep; i < fileList.length; i++) {
    fileList[i].setTrashed(true);
  }
}

// ============= MENU FUNCTIONS =============

/**
 * Create custom menu in Google Sheets
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üó∫Ô∏è Map Sync')
    .addItem('‚ö° Sync Now', 'syncSheetToMap')
    .addItem('‚öôÔ∏è Setup Auto-Sync', 'setupAutoSync')
    .addItem('üîç Check Sync Status', 'checkSyncStatus')
    .addSeparator()
    .addItem('üìç Open My Map', 'openMyMap')
    .addItem('‚ùå Stop Auto-Sync', 'stopAutoSync')
    .addToUi();
}

/**
 * Check sync status
 */
function checkSyncStatus() {
  const triggers = ScriptApp.getProjectTriggers();
  const hasTrigger = triggers.some(t => t.getHandlerFunction() === 'syncSheetToMap');
  
  if (hasTrigger) {
    SpreadsheetApp.getUi().alert(
      '‚úÖ Auto-sync is ACTIVE\n\n' +
      `Syncing every ${CONFIG.REFRESH_INTERVAL} minutes\n` +
      'Your map updates automatically when you edit the sheet!'
    );
  } else {
    SpreadsheetApp.getUi().alert(
      '‚ùå Auto-sync is INACTIVE\n\n' +
      'Click "Setup Auto-Sync" to enable automatic updates.'
    );
  }
}

/**
 * Open Google My Map in new tab
 */
function openMyMap() {
  const htmlOutput = HtmlService.createHtmlOutput(`
    <script>
      window.open('https://www.google.com/maps/d/u/0/edit?mid=${CONFIG.MAP_ID}', '_blank');
      google.script.host.close();
    </script>
  `);
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Opening Map...');
}

/**
 * Stop auto-sync
 */
function stopAutoSync() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  SpreadsheetApp.getUi().alert('Auto-sync has been stopped.');
}
